@using AdvantShop.Web.Admin.ViewModels.Common
@using Newtonsoft.Json
@model AdvantShop.Web.Admin.Models.Orders.OrdersEdit.OrderModel
@{
    var order = Model.Order;
    var orderCustomer = order != null ? order.OrderCustomer : null;
    var isNewOrDraft = order == null || order.IsDraft;
    var isMobile = SettingsDesign.IsMobileTemplate;
}
<div class="order-customer">
    <div class="m-b-sm @(isMobile ? "order-content__header" : "")">
        <h2 class="inline order-customer__title">
            @(orderCustomer != null ? T("Admin.Orders.OrderCustomer.Customer").ToString() : T("Admin.Orders.OrderCustomer.CreateOrFindCustomer").ToString())
        </h2>
        @if (!isMobile)
        {
            if (Model.Customer != null)
            {
                <a href="@Url.AbsoluteActionUrl("View", "Customers", new {id = Model.Customer.Id})" target="_blank" class="edit link-decoration-none">@T("Admin.Orders.OrderCustomer.ClientCard")</a>
            }
        }

        <div class="order-customer__choose-block  @(orderCustomer == null ? "m-b" : "m-l-sm inline")">
            <ui-modal-trigger data-controller="'ModalSelectCustomerCtrl'" controller-as="ctrl" size="middle"
                              template-url="@Html.GetAssetPath("selectCustomer.html")"
                              data-on-close="order.selectCustomer(result)">
                <a href="" class="edit order-customer__edit  @(isMobile ? "" : "link-decoration-none")">@T(Model.Customer != null ? "Сменить покупателя" : "Admin.Orders.OrderCustomer.SelectCustomer")</a>
            </ui-modal-trigger>
            <span ng-if="order.selectedFirstName != null && order.selectedLastName != null" class="ng-cloak m-l-xs link-invert order-customer__current-customer">
                @if(!isMobile){
                    <a target="_blank" href="customers/view/{{order.customerId}}" data-ng-bind="order.selectedFirstName + ' ' + order.selectedLastName"></a>
                }
                <a href="" ng-click="order.resetOrderCustomer()" ng-if="order.isDraft" class="link-invert fas fa-times @(isMobile ? "" : "link-decoration-none")" data-e2e="RemoveOrderCustomer"></a>
            </span>
        </div>
    </div>
        @if(isMobile){
             <div class="m-t m-b">
                    <a target="_blank" href="customers/view/{{order.customerId}}"  data-ng-bind="order.selectedFirstName + ' ' + order.selectedLastName"></a>
             </div>    
        }
    @if (Model.Customer == null && Model.IsEditMode)
    {
        <div class="m-b">
            <a target="_blank" data-e2e="SaveCustomer" href="customers/add?orderid=@Model.OrderId" class="ng-cloak m-l-xs link-invert order-customer__create-user">
                @T("Admin.Orders.OrderCustomer.CreateUserFromOrder")
            </a>
        </div>
    }

    <ng-form novalidate="" class="order-customer__form order-customer-form" name="orderCustomerForm">
        <div class="row">
            <div class="col-xs-12 col-md-6">
                <div class="order-customer-form__content order-customer-form__content--indent">
                    <div>
                        <div class="row">
                            <div class="col-xs-12 col-md-4">
                                <div class="row form-group">
                                    <div class="col-xs-12">
                                        <label class="control-label text-left">@T("Admin.Orders.OrderCustomer.LastName")</label>
                                    </div>
                                    <div class="col-xs-12">
                                        @Html.TextBoxFor(x => x.Order.OrderCustomer.LastName, new
                                        {
                                            @class = "form-control input-alt-mobile",
                                            ng_model = "order.lastName",
                                            ng_blur = "order.isDraft && orderCustomerForm['Order.OrderCustomer.LastName'].modified === true && order.changeCustomer(orderCustomerForm)",
                                            uib_typeahead = "item.LastName for item in order.findCustomersByFullNameParts($viewValue)",
                                            typeahead_template_url = "../areas/admin/content/src/order/templates/autocompleteCustomers.html",
                                            typeahead_on_select = "order.selectCustomerByAutocomplete($item, $model, $label)",
                                            typeahead_focus_first = "false"
                                        })
                                    </div>
                                </div>
                            </div>

                            <div class="col-xs-12 col-md-4">
                                <div class="row form-group">
                                    <div class="col-xs-12">
                                        <label class="control-label text-left">@T("Admin.Orders.OrderCustomer.FirstName")</label>
                                    </div>
                                    <div class="col-xs-12">
                                        @Html.TextBoxFor(x => x.Order.OrderCustomer.FirstName, new
                                        {
                                            @class = "form-control input-alt-mobile",
                                            ng_model = "order.firstName",
                                            ng_blur = "order.isDraft && orderCustomerForm['Order.OrderCustomer.FirstName'].modified === true && order.changeCustomer(orderCustomerForm)",
                                            uib_typeahead = "item.FirstName for item in order.findCustomersByFullNameParts($viewValue)",
                                            typeahead_template_url = "../areas/admin/content/src/order/templates/autocompleteCustomers.html",
                                            typeahead_on_select = "order.selectCustomerByAutocomplete($item, $model, $label)",
                                            typeahead_focus_first = "false"
                                        })
                                    </div>
                                </div>
                            </div>

                            <div class="col-xs-12 col-md-4">
                                <div class="row form-group">
                                    <div class="col-xs-12">
                                        <label class="control-label text-left">@T("Admin.Orders.OrderCustomer.Patronymic")</label>
                                    </div>
                                    <div class="col-xs-12">
                                        @Html.TextBoxFor(x => x.Order.OrderCustomer.Patronymic, new
                                        {
                                            @class = "form-control input-alt-mobile",
                                            ng_model = "order.patronymic",
                                            ng_blur = "order.isDraft && orderCustomerForm['Order.OrderCustomer.Patronymic'].modified === true && order.changeCustomer(orderCustomerForm)",
                                            uib_typeahead = "item.Patronymic for item in order.findCustomersByFullNameParts($viewValue)",
                                            typeahead_template_url = "../areas/admin/content/src/order/templates/autocompleteCustomers.html",
                                            typeahead_on_select = "order.selectCustomerByAutocomplete($item, $model, $label)",
                                            typeahead_focus_first = "false"
                                        })
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                    @if (Model.Order.OrderCustomer != null && !string.IsNullOrEmpty(Model.Order.OrderCustomer.Organization))
                    {
                        <div class="form-group">
                            <div class="row">
                                <div class="col-xs-12">
                                    <label class="control-label text-left">@T("Admin.Orders.OrderCustomer.Organization")</label>
                                </div>

                                <div class="col-xs-12">
                                    <div class="row between-xs middle-xs">
                                        <div class="col-xs">
                                            @Html.Label(Model.Order.OrderCustomer.Organization, new
                                            {
                                                @class = "form-control",
                                            })
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }

                    <div class="form-group">
                        <div class="row">
                            <div class="col-xs-12">
                                <label class="control-label text-left">Email</label>
                            </div>

                            <div class="col-xs-12">
                                <div class="row between-xs middle-xs">
                                    <div class="col-xs">
                                        @Html.TextBoxFor(x => x.Order.OrderCustomer.Email, new
                                        {
                                            @class = "form-control input-alt-mobile",
                                            ng_model = "order.email",
                                            ng_blur = "order.isDraft && orderCustomerForm['Order.OrderCustomer.Email'].modified === true && order.changeCustomer(orderCustomerForm)",
                                            pattern = "^([a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\\.[a-zA-Z0-9-.]+)|(admin)$",
                                            uib_typeahead = "item.Email for item in order.findCustomers($viewValue)",
                                            typeahead_template_url = "../areas/admin/content/src/order/templates/autocompleteCustomers.html",
                                            typeahead_on_select = "order.selectCustomerByAutocomplete($item, $model, $label)",
                                            typeahead_focus_first = "false"
                                        })
                                    </div>
                                    @if (!isNewOrDraft)
                                    {
                                        <div class="col-xs flex-grow-n text-nowrap" ng-if="order.email != null && order.email.length > 0 && orderCustomerForm['Order.OrderCustomer.Email'].$error.pattern == null">
                                            <ui-modal-trigger data-controller="'ModalSendLetterToCustomerCtrl'" controller-as="ctrl" size="lg"
                                                              template-url="@Html.GetAssetPath("sendLetterToCustomer.html")"
                                                              data-resolve="{params: {@(orderCustomer != null ? "customerId: '" + orderCustomer.CustomerID + "'," : "") email: order.email, firstName: order.firstName, lastName: order.lastName, patronymic: order.patronymic, orderId: order.orderId, pageType: 'order'}}"
                                                              data-on-close="order.updateLeadEventsWithDelay()">
                                                <a href="" class="edit link-decoration-none">@T("Admin.Orders.OrderCustomer.SendEmail")</a>
                                            </ui-modal-trigger>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="row">
                            <div class="col-xs-12">
                                <label class="control-label text-left">@T("Admin.Orders.OrderCustomer.PhoneInNumberFormat")</label>
                            </div>
                            <div class="col-xs-12">
                                <div class="row between-xs middle-xs">
                                    <div class="col-xs-12 col-md">
                                        @Html.TextBoxFor(x => x.Order.OrderCustomer.Phone,
                                            order == null || order.IsDraft
                                                ? new Dictionary<string, object>()
                                                {
                                                    {"class", "form-control input-alt-mobile"},
                                                    {"ng-model", "order.phone"},
                                                    {"ng-blur", "order.isDraft && orderCustomerForm['Order.OrderCustomer.Phone'].modified === true && order.changeCustomer(orderCustomerForm)"},
                                                    {"uib-typeahead", "item.Phone for item in order.findCustomersByPhone($viewValue)"},
                                                    {"typeahead-template-url", "../areas/admin/content/src/order/templates/autocompleteCustomers.html"},
                                                    {"typeahead-on-select", "order.selectCustomerByAutocomplete($item, $model, $label)"},
                                                    {"typeahead-focus-first", "false"},
                                                    {"mask-control-preset", "phone"},
                                                    {"mask-control", ""}
                                                }
                                                : new Dictionary<string, object>()
                                                {
                                                    {"class", "form-control input-alt-mobile"},
                                                    {"ng-model", "order.phone"},
                                                    {"mask-control-preset", "phone"},
                                                    {"mask-control", ""},
                                                })
                                    </div>
                                    <div class="col-xs flex-grow-n text-nowrap">
                                        @if (Model.StandardPhone != null)
                                        {
                                            <a href="tel:@Model.StandardPhone" ng-href="tel:{{order.phone}}" class="edit link-decoration-none m-t-xs m-b-xs" onclick="return advTrack('@AdvantShop.Track.ETrackEvent.Core_Orders_CallCustomer.ToString()');">
                                                @T("Admin.Orders.OrderCustomer")
                                            </a>

                                            if (orderCustomer != null)
                                            {
                                                <ui-modal-trigger data-controller="'ModalSendSmsAdvCtrl'" controller-as="ctrl" size="middle"
                                                                  class="inline-block m-t-xs m-b-xs"
                                                                  data-resolve="{params: { customerId: '@orderCustomer.CustomerID', phone: order.phone, orderId: '@Model.OrderId', pageType: 'order'}}"
                                                                  template-url="@Html.GetAssetPath("sendSms.html")">
                                                    <a href="" class="edit link-decoration-none m-l-xs">@T("Admin.Orders.OrderCustomer.SendSms")</a>
                                                </ui-modal-trigger>
                                            }
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    @if (Model.ShowCustomerType)
                    {
                        <div class="form-group">
                            <div class="row  m-b-sm">
                                <div class="col-xs-12">
                                    <label class="control-label text-left">@T("Admin.Orders.OrderCustomer.CustomerType")</label>
                                </div>

                                <div class="col-xs-12">
                                    <div class="row between-xs middle-xs">
                                        <div class="col-xs">
                                            @Html.DropDownListFor(x => x.Order.OrderCustomer.CustomerType, Model.CustomerTypes, new
                                            {
                                                @class = "form-control input-alt",
                                                ng_model = "order.customerType",
                                                ng_blur = "order.isDraft && orderCustomerForm['Order.OrderCustomer.CustomerType'].modified === true && order.changeCustomer(orderCustomerForm)",
                                                ng_change = "order.getCustomerFields()"
                                            })
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                    else if (Model.Order.OrderCustomer != null)
                    {
                        <span ng-model="order.customerType" ng-init="order.customerType='@Model.Order.OrderCustomer.CustomerType'"></span>
                    }

                    @Html.RenderModules("admin_order_ordercustomer_left", new { orderId = Model.OrderId })
                </div>
            </div>

            <div class="col-xs-12 col-md-6">
                @if (SettingsCheckout.IsShowCustomShippingField1 || (orderCustomer != null && !string.IsNullOrEmpty(order.OrderCustomer.CustomField1)))
                {
                    <div class="form-group">
                        <div class="row">
                            <div class="col-xs-12">
                                <label class="control-label text-left">@SettingsCheckout.CustomShippingField1</label>
                            </div>
                            <div class="col-xs">
                                @Html.TextBoxFor(x => x.Order.OrderCustomer.CustomField1, new
                                {
                                    @class = "form-control input-alt-mobile",
                                    ng_model = "order.customField1",
                                    ng_blur = "order.isDraft && orderCustomerForm['Order.OrderCustomer.CustomField1'].modified === true && order.changeCustomer(orderCustomerForm)"
                                })
                            </div>
                        </div>
                    </div>
                }
                @if (SettingsCheckout.IsShowCustomShippingField2 || (orderCustomer != null && !string.IsNullOrEmpty(order.OrderCustomer.CustomField2)))
                {
                    <div class="form-group">
                        <div class="row">
                            <div class="col-xs-12">
                                <label class="control-label text-left">@SettingsCheckout.CustomShippingField2</label>
                            </div>
                            <div class="col-xs">
                                @Html.TextBoxFor(x => x.Order.OrderCustomer.CustomField2, new
                                {
                                    @class = "form-control input-alt-mobile",
                                    ng_model = "order.customField2",
                                    ng_blur = "order.isDraft && orderCustomerForm['Order.OrderCustomer.CustomField2'].modified === true && order.changeCustomer(orderCustomerForm)"
                                })
                            </div>
                        </div>
                    </div>
                }
                @if (SettingsCheckout.IsShowCustomShippingField3 || (orderCustomer != null && !string.IsNullOrEmpty(order.OrderCustomer.CustomField3)))
                {
                    <div class="form-group">
                        <div class="row">
                            <div class="col-xs-12">
                                <label class="control-label text-left">@SettingsCheckout.CustomShippingField3</label>
                            </div>
                            <div class="col-xs">
                                @Html.TextBoxFor(x => x.Order.OrderCustomer.CustomField3, new
                                {
                                    @class = "form-control input-alt-mobile",
                                    ng_model = "order.customField3",
                                    ng_blur = "order.isDraft && orderCustomerForm['Order.OrderCustomer.CustomField3'].modified === true && order.changeCustomer(orderCustomerForm)"
                                })
                            </div>
                        </div>
                    </div>
                }
                @Html.RenderModules("admin_order_ordercustomer_right", new { orderId = Model.OrderId })
            </div>
        </div>

        @if (Model.CustomerFields != null)
        {
            <div class="customer-custom-fields-divider"></div>
            <div class="row customer-custom-fields order-customer-fields" ng-init="order.initCustomerFields(@JsonConvert.SerializeObject(Model.CustomerFields))">
                <customer-fields customerfields-js="order.customerFields" customer-type="order.customerType"
                                 class="flex-grow" on-init="order.onCustomerFieldsInit(reloadFn)" customer-id="order.customerId">
                </customer-fields>
            </div>
        }
    </ng-form>
</div>